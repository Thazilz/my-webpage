<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory</title>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  nav a { margin-right: 10px; text-decoration: none; color: black; }
  nav button { float: right; border: 1px solid #ccc; padding: 6px 10px; cursor: pointer; }
  nav button:hover { background: #eee; }
  form input, form button, select { display:block; margin-bottom:10px; padding:8px; width:100%; }
  .item { padding: 8px; border: 1px solid #ccc; margin-bottom: 10px; border-radius:6px; background:white; }
  .item img { max-width:120px; display:block; margin-top:6px; }
  .error { color:red; }
  .success { color:green; }
</style>
</head>
<body>

<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a>
  <a href="approval.html" id="approvalsLink" style="display:none;">| Approvals</a>
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Inventory Management</h2>

  <div id="addItemSection">
  <h3>Add New Item</h3>

  <form id="addItemForm">

<form id="addItemForm">
  <input type="text" id="itemName" placeholder="Item Name" required />
  <input type="text" id="brand" placeholder="Brand" required />
  <input type="text" id="modelNumber" placeholder="Model Number" required />
  <input type="text" id="serialNumber" placeholder="Serial Number" required />
  <input type="file" id="imageFile" accept="image/*" />
  <button type="submit">Add Item</button>
</form>
</div>


<p id="msg"></p>

<h3>Filter Inventory</h3>
<label for="filterName">Item Name:</label>
<select id="filterName"><option value="">-- All Names --</option></select>

<label for="filterBrand">Brand:</label>
<select id="filterBrand"><option value="">-- All Brands --</option></select>

<label for="filterModel">Model Number:</label>
<select id="filterModel"><option value="">-- All Models --</option></select>

<h3>Inventory List</h3>
<div id="inventoryList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
  authDomain: "my-webpage-93c94.firebaseapp.com",
  databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-webpage-93c94",
  storageBucket: "my-webpage-93c94.appspot.com",
  messagingSenderId: "959385466155",
  appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
};

let isAdmin = false;
const addItemSection = document.getElementById("addItemSection");
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

const approvalsLink = document.getElementById("approvalsLink");
const logoutBtn = document.getElementById("logoutBtn");
const inventoryList = document.getElementById("inventoryList");
const addItemForm = document.getElementById("addItemForm");
const msg = document.getElementById("msg");

const filterName = document.getElementById("filterName");
const filterBrand = document.getElementById("filterBrand");
const filterModel = document.getElementById("filterModel");

let allInventory = {}; // store all inventory for filtering


logoutBtn.addEventListener("click", () => signOut(auth).then(() => window.location.href="login.html"));

// Auth Check & Approvals link
onAuthStateChanged(auth, async user => {
  if (!user) return (window.location.href = "login.html");

  const token = await user.getIdTokenResult();

  if (token.claims.admin) {
    approvalsLink.style.display = "inline";
    isAdmin = true;   // admin stored
  } else {
    addItemSection.style.display = "none"; // hide Add Item for non-admins
  }

  loadInventory();
});

// Load Inventory
function loadInventory() {
  const invRef = ref(db, "inventory");

  onValue(invRef, snap => {
    const data = snap.val() || {};
    allInventory = data; // store for filtering
    populateFilters(data);
    renderInventory(data);
  });
}

// Render Inventory List
function renderInventory(data) {
  inventoryList.innerHTML = "";
  if(!data || Object.keys(data).length === 0){
    inventoryList.innerHTML = "<p>No items found.</p>";
    return;
  }

  Object.entries(data).forEach(([itemId, item]) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
  <strong>${item.itemName}</strong><br>
  Brand: ${item.brand}<br>
  Model: ${item.modelNumber}<br>
  Serial: ${item.serialNumber}<br>
  Available: <b>${item.available ? "Yes" : "No"}</b><br>
  ${item.imageUrl ? `<img src="${item.imageUrl}">` : ""}

  <br>
  <a href="loan.html?itemId=${encodeURIComponent(item.serialNumber)}&model=${encodeURIComponent(item.modelNumber)}&brand=${encodeURIComponent(item.brand)}">
    <button>Loan Item</button>
  </a>

  ${isAdmin ? `<button data-id="${itemId}" class="deleteBtn">Delete</button>` : ""}
`;

    inventoryList.appendChild(div);
  });

  attachDeleteHandlers();
}

// Populate filter dropdowns
function populateFilters(data){
  const nameSet = new Set();
  const brandSet = new Set();
  const modelSet = new Set();

  Object.values(data).forEach(item=>{
    if(item.itemName) nameSet.add(item.itemName);
    if(item.brand) brandSet.add(item.brand);
    if(item.modelNumber) modelSet.add(item.modelNumber);
  });

  filterName.innerHTML = '<option value="">-- All Names --</option>';
  Array.from(nameSet).sort().forEach(v=> filterName.appendChild(new Option(v,v)));
  
  filterBrand.innerHTML = '<option value="">-- All Brands --</option>';
  Array.from(brandSet).sort().forEach(v=> filterBrand.appendChild(new Option(v,v)));
  
  filterModel.innerHTML = '<option value="">-- All Models --</option>';
  Array.from(modelSet).sort().forEach(v=> filterModel.appendChild(new Option(v,v)));
}

// Apply filters
function applyFilters(){
  const nameVal = filterName.value;
  const brandVal = filterBrand.value;
  const modelVal = filterModel.value;

  const filtered = {};
  Object.entries(allInventory).forEach(([id,item])=>{
    if((!nameVal || item.itemName===nameVal) &&
       (!brandVal || item.brand===brandVal) &&
       (!modelVal || item.modelNumber===modelVal)){
         filtered[id] = item;
    }
  });
  renderInventory(filtered);
}

filterName.addEventListener("change", applyFilters);
filterBrand.addEventListener("change", applyFilters);
filterModel.addEventListener("change", applyFilters);

// Delete Item
function attachDeleteHandlers(){
  document.querySelectorAll(".deleteBtn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.dataset.id;
      if(!confirm("Delete this item?")) return;
      await remove(ref(db, "inventory/" + id));
    });
  });
}

// Add Item
addItemForm.addEventListener("submit", async e=>{
  e.preventDefault();
  msg.textContent = "";
  msg.className = "";

  const name = itemName.value.trim();
  const brandVal = brand.value.trim();
  const modelVal = modelNumber.value.trim();
  const serial = serialNumber.value.trim();
  const file = imageFile.files[0];

  if(!name || !brandVal || !modelVal || !serial){
    msg.textContent = "All fields except image are required.";
    msg.className = "error";
    return;
  }

  const q = query(ref(db, "inventory"), orderByChild("serialNumber"), equalTo(serial));
  const existing = await get(q);
  if(existing.exists()){
    msg.textContent = "Serial number already exists.";
    msg.className = "error";
    return;
  }

  let imageUrl = "";
  if(file){
    const storageRef = sRef(storage, `inventory/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    imageUrl = await getDownloadURL(storageRef);
  }

  const newItemRef = push(ref(db, "inventory"));
  await set(newItemRef,{
    itemName: name,
    brand: brandVal,
    modelNumber: modelVal,
    serialNumber: serial,
    imageUrl,
    available: true
  });

  msg.textContent = "Item added successfully!";
  msg.className = "success";
  addItemForm.reset();
});
</script>
</body>
</html>




