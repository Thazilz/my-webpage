<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Return Form with NFC</title>
  <style>
    body { font-family: Arial; padding: 20px; }

    /* Navigation styles - plain like index.html */
    nav {
      font-family: Arial, sans-serif;
      margin-bottom: 20px;
    }
    nav a {
      color: black;
      text-decoration: none;
      margin-right: 10px;
    }
    nav a:hover {
      text-decoration: underline;
    }
    nav button {
      font-family: Arial, sans-serif;
      padding: 6px 12px;
      cursor: pointer;
      background: none;
      border: 1px solid #ccc;
      color: black;
      float: right;
    }
    nav button:hover {
      background: #f0f0f0;
    }

    form { max-width: 400px; margin: auto; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; }
    button[type="submit"], #scanNfcBtn { padding: 10px 20px; margin-bottom: 10px; }
    .success { color: green; }
    .error { color: red; }

    #returnList { max-width: 400px; margin: 20px auto; }
    #returnList h3 { margin-bottom: 10px; }
    #returnList ul { list-style-type: none; padding-left: 0; }
    #returnList li { background: #f9f9f9; margin-bottom: 8px; padding: 10px; border-radius: 4px; }
    #returnList li strong { display: block; margin-bottom: 5px; }
  </style>
</head>
<body>

<!-- Hardcoded Navigation -->
<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html">Approvals</a> |
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Return Equipment</h2>

<form id="returnForm">
  <label for="returnName">Your Name</label>
  <input type="text" id="returnName" required />

  <label for="returnEmail">Your Email</label>
  <input type="email" id="returnEmail" required />

  <label for="itemReturned">Item Name or ID</label>
  <input type="text" id="itemReturned" required />

  <label for="returnNotes">Return Notes (optional)</label>
  <textarea id="returnNotes"></textarea>

  <button type="button" id="scanNfcBtn">üì≤ Scan NFC Tag</button> |
  <button type="submit">Submit Return</button>
</form>

<p id="returnResponse"></p>

<div id="returnList">
  <h3>Return Records:</h3>
  <ul id="returnUl"></ul>
</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    get,
    update,
    query,
    orderByChild,
    equalTo,
    serverTimestamp,
    onChildAdded,
    onChildChanged
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
    authDomain: "my-webpage-93c94.firebaseapp.com",
    databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-webpage-93c94",
    storageBucket: "my-webpage-93c94.appspot.com",
    messagingSenderId: "959385466155",
    appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Redirect unauthenticated users
  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "login.html";
    }
  });

  // Logout button
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "login.html";
    } catch (err) {
      console.error("Logout failed:", err);
      alert("‚ùå Logout failed");
    }
  });

  const returnRef = ref(db, 'returns');
  const loansRef = ref(db, 'loans');

  const returnForm = document.getElementById('returnForm');
  const returnResponse = document.getElementById('returnResponse');
  const returnUl = document.getElementById('returnUl');

  // Submit return form
  returnForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('returnName').value.trim();
    const email = document.getElementById('returnEmail').value.trim();
    const item = document.getElementById('itemReturned').value.trim().toLowerCase();
    const notes = document.getElementById('returnNotes').value.trim();

    if (!name || !email || !item) {
      returnResponse.textContent = "Please fill in all required fields.";
      returnResponse.className = "error";
      return;
    }

    try {
      const loanQuery = query(loansRef, orderByChild("itemId"), equalTo(item));
      const loanSnapshot = await get(loanQuery);

      let activeLoanKey = null;

      loanSnapshot.forEach(child => {
        const loan = child.val();
        if (loan.status === "active") activeLoanKey = child.key;
      });

      if (!activeLoanKey) {
        returnResponse.textContent = "‚ùå No active loan found for this item.";
        returnResponse.className = "error";
        return;
      }

      await push(returnRef, {
        name,
        email,
        item,
        notes,
        timestamp: serverTimestamp()
      });

      await update(ref(db, `loans/${activeLoanKey}`), { status: "returned" });

      returnResponse.textContent = "‚úÖ Return submitted and loan marked as returned!";
      returnResponse.className = "success";
      returnForm.reset();

    } catch (error) {
      console.error("‚ùå Firebase error:", error);
      returnResponse.textContent = "Error submitting return or updating loan.";
      returnResponse.className = "error";
    }
  });

  // Display return records
  onChildAdded(returnRef, (data) => {
    const { name, email, item, notes, timestamp } = data.val();

    let dateStr = "Pending timestamp...";
    if (timestamp) {
      if (typeof timestamp === 'object' && timestamp.seconds) dateStr = new Date(timestamp.seconds * 1000).toLocaleString();
      else if (typeof timestamp === 'number') dateStr = new Date(timestamp).toLocaleString();
    }

    const li = document.createElement('li');
    li.id = data.key;
    li.innerHTML = `
      <strong>${name} (${email})</strong>
      <em>${dateStr}</em>
      <p><strong>Item:</strong> ${item}</p>
      ${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ""}
    `;
    returnUl.prepend(li);
  });

  onChildChanged(returnRef, (data) => {
    const { name, email, item, notes, timestamp } = data.val();

    let dateStr = "Pending timestamp...";
    if (timestamp) {
      if (typeof timestamp === 'object' && timestamp.seconds) dateStr = new Date(timestamp.seconds * 1000).toLocaleString();
      else if (typeof timestamp === 'number') dateStr = new Date(timestamp).toLocaleString();
    }

    const li = document.getElementById(data.key);
    if (li) {
      li.innerHTML = `
        <strong>${name} (${email})</strong>
        <em>${dateStr}</em>
        <p><strong>Item:</strong> ${item}</p>
        ${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ""}
      `;
    }
  });

  // NFC Scan Handler
  const scanNfcBtn = document.getElementById('scanNfcBtn');
  scanNfcBtn.addEventListener('click', async () => {
    if ('NDEFReader' in window) {
      const reader = new NDEFReader();

      try {
        await reader.scan();
        returnResponse.textContent = "NFC scan started. Tap a tag...";
        returnResponse.className = "";

        reader.onreading = (event) => {
          for (const record of event.message.records) {
            if (record.recordType === "text") {
              const textDecoder = new TextDecoder(record.encoding || "utf-8");
              const data = textDecoder.decode(record.data).trim().toLowerCase();
              document.getElementById('itemReturned').value = data;
              returnResponse.textContent = `Scanned: ${data}`;
              returnResponse.className = "success";
              break;
            }
          }
        };

        reader.onerror = (event) => {
          console.error("NFC Read Error", event);
          returnResponse.textContent = "NFC scan failed.";
          returnResponse.className = "error";
        };

      } catch (err) {
        console.error("NFC error:", err);
        returnResponse.textContent = "Error starting NFC scan. Make sure your phone supports NFC and you're using a compatible browser.";
        returnResponse.className = "error";
      }
    } else {
      alert("‚ùå Web NFC not supported in this browser.");
    }
  });
</script>

</body>
</html>



