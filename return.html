<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Return Item</title>
<style>
  body { font-family: Arial; padding: 20px; }
  nav { margin-bottom: 20px; }
  nav a { color: black; text-decoration: none; margin-right: 10px; }
  nav button { padding: 6px 12px; cursor: pointer; background: none; border: 1px solid #ccc; float: right; }
  nav button:hover { background: #f0f0f0; }
  form input, form select, form button { display: block; margin-bottom: 10px; padding: 8px; width: 100%; }
  .success { color: green; }
  .error { color: red; }
</style>
</head>
<body>

<!-- Navbar -->
<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html" id="approvalsLink" style="display:none;">Approvals</a>
  <button id="logoutBtn">Logout</button>
</nav>

<h2>Return an Item</h2>

<form id="returnForm">
  <label for="loanSelect">Select Loan to Return:</label>
  <select id="loanSelect" required>
    <option value="">-- Loading your active loans --</option>
  </select>

  <label for="returnDate">Return Date:</label>
  <input type="date" id="returnDate" required />

  <button type="submit">Submit Return Request</button>
</form>

<p id="responseMsg"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
  authDomain: "my-webpage-93c94.firebaseapp.com",
  databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-webpage-93c94",
  storageBucket: "my-webpage-93c94.appspot.com",
  messagingSenderId: "959385466155",
  appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const returnForm = document.getElementById("returnForm");
const loanSelect = document.getElementById("loanSelect");
const returnDateInput = document.getElementById("returnDate");
const responseMsg = document.getElementById("responseMsg");
const logoutBtn = document.getElementById("logoutBtn");
const approvalsLink = document.getElementById("approvalsLink");

let userLoans = {}; // key = loanId, value = loan data

// Logout handler
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

onAuthStateChanged(auth, async user => {
  if (!user) return (window.location.href = "login.html");

  // Show Approvals link only for Admins
  const token = await user.getIdTokenResult();
  if (token.claims.admin) {
    approvalsLink.style.display = "inline";
  }

  // Load user's active loans
  const loansRef = ref(db, "loans");
  onValue(loansRef, snapshot => {
    const data = snapshot.val() || {};
    loanSelect.innerHTML = '<option value="">-- Select a loan --</option>';
    userLoans = {};

    Object.entries(data).forEach(([loanId, loan]) => {
      if (loan.borrowerUid === user.uid && loan.status === "active") {
        userLoans[loanId] = loan;
        const option = document.createElement("option");
        option.value = loanId;
        option.textContent = `${loan.itemId} (${loan.model} | ${loan.brand}) - Loaned: ${loan.loanDate}`;
        loanSelect.appendChild(option);
      }
    });

    if (Object.keys(userLoans).length === 0) {
      loanSelect.innerHTML = '<option value="">No active loans to return</option>';
    }
  });
});

returnForm.addEventListener("submit", async e => {
  e.preventDefault();
  responseMsg.textContent = "";
  const selectedLoanId = loanSelect.value;
  const returnDate = returnDateInput.value;

  if (!selectedLoanId) {
    responseMsg.textContent = "Please select a loan to return.";
    responseMsg.className = "error";
    return;
  }

  const loan = userLoans[selectedLoanId];

  if (new Date(returnDate) < new Date(loan.loanDate)) {
    responseMsg.textContent = "Return date cannot be before loan date.";
    responseMsg.className = "error";
    return;
  }

  try {
    // Create return request with loanKey included
    await push(ref(db, "returns"), {
      itemId: loan.itemId,
      model: loan.model,
      brand: loan.brand,
      borrowerUid: loan.borrowerUid,
      borrowerName: loan.borrowerName,
      department: loan.department,
      loanKey: selectedLoanId,        // âœ… Link to original loan
      returnDate,
      status: "pendingApproval",
      timestamp: Date.now()
    });

    responseMsg.textContent = "Return request submitted successfully!";
    responseMsg.className = "success";
    returnForm.reset();
  } catch (err) {
    console.error(err);
    responseMsg.textContent = "Error submitting return request.";
    responseMsg.className = "error";
  }
});
</script>
</body>
</html>




