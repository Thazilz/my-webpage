<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan Form</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }

    nav { margin-bottom: 20px; }
    nav a { color: black; text-decoration: none; margin-right: 10px; }
    nav a:hover { text-decoration: underline; }
    nav button {
      padding: 6px 12px; cursor: pointer;
      background: none; border: 1px solid #ccc;
      color: black; float: right;
    }

    form {
      max-width: 600px; margin: auto; background: #fff;
      padding: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px 20px;
      align-items: center;
    }

    label { text-align: right; font-weight: bold; }

    input, select {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
    }

    button[type="submit"] {
      grid-column: 2 / 3; padding: 10px 20px;
      background-color: #28a745; color: white; border: none; cursor: pointer;
      border-radius: 4px;
    }
    button[type="submit"]:disabled {
      background-color: #ccc; cursor: not-allowed;
    }

    .success { color: green; grid-column: 2 / 3; }
    .error { color: red; grid-column: 2 / 3; }

    #loanList { max-width: 800px; margin: 30px auto; }
    #loanList ul { list-style: none; padding: 0; }
    #loanList li {
      background: #e9ecef; margin-bottom: 10px;
      padding: 10px; border-radius: 5px; border-left: 5px solid #999;
    }

    #approvalsLink { display: none; }

.loan-status-pending {
  border-left-color: orange !important;
  background: #fff4e6;
}

.loan-status-active {
  border-left-color: green !important;
  background: #e8f8e8;
}

.loan-status-returned {
  border-left-color: blue !important;
  background: #e7f0ff;
}

.loan-status-rejected {
  border-left-color: red !important;
  background: #ffe6e6;
}

  </style>
</head>
<body>

<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html" id="approvalsLink">Approvals</a>
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Loan an Item</h2>
<p><a href="inventory.html">ðŸ”™ Back to Inventory</a></p>

<form id="loanForm">
  <label for="borrowerName">Name:</label>
  <input type="text" id="borrowerName" readonly />

  <label for="department">Department:</label>
  <input type="text" id="department" readonly />

  <label for="phone">Phone:</label>
  <input type="text" id="phone" readonly />

  <label for="itemId">Item ID:</label>
  <input type="text" id="itemId" placeholder="Enter Item ID" required />

  <label for="model">Model:</label>
  <input type="text" id="model" readonly />

  <label for="brand">Brand:</label>
  <input type="text" id="brand" readonly />

  <label for="loanDate">Loan Date:</label>
  <input type="date" id="loanDate" required />

  <label for="returnDate">Return Date:</label>
  <input type="date" id="returnDate" required />

  <button type="submit" disabled>Submit Loan</button>
</form>

<p id="loanResponseMsg"></p>

<div id="loanList">
  <h3>Your Loan Records</h3>
  <label for="userMonthSelect">Select Month:</label>
  <select id="userMonthSelect">
    <option value="">--Select Month--</option>
  </select>
  <ul id="loanUl" style="display:none;"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, get, onValue, query, orderByChild, equalTo, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
  authDomain: "my-webpage-93c94.firebaseapp.com",
  databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-webpage-93c94",
  storageBucket: "my-webpage-93c94.appspot.com",
  messagingSenderId: "959385466155",
  appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const loanForm = document.getElementById("loanForm");
const submitButton = loanForm.querySelector("button");
const loanResponseMsg = document.getElementById("loanResponseMsg");

const itemIdInput = document.getElementById("itemId");
const modelInput = document.getElementById("model");
const brandInput = document.getElementById("brand");

const borrowerNameInput = document.getElementById("borrowerName");
const departmentInput = document.getElementById("department");
const phoneInput = document.getElementById("phone");

const loansRef = ref(db, "loans");
const inventoryRef = ref(db, "inventory");
const usersRef = ref(db, "users");

let inventoryLoaded = false;
const inventoryMap = new Map();
let allLoans = {};

/* Helpers */
function cleanId(str) { return str ? str.trim() : ""; }
function getMonthLabel(dateStr) {
  const date = new Date(dateStr);
  const options = { year: "numeric", month: "long" };
  return date.toLocaleDateString(undefined, options);
}

/* ------------------------------------------------------------------
   Load User Info
------------------------------------------------------------------ */
onAuthStateChanged(auth, user => {
  if(!user) return location.href="login.html";

const approvalsLink = document.getElementById("approvalsLink");

// Show Approvals link only for admins
get(ref(db, `users/${user.uid}`)).then(snapshot => {
  const u = snapshot.val();
  if(u){
    borrowerNameInput.value = u.name || "";
    departmentInput.value = u.department || u.section || "";
    phoneInput.value = u.phone || "";

    if(u.isAdmin) approvalsLink.style.display = "inline"; // show only for admins
  }
});

  get(ref(db, `users/${user.uid}`)).then(snapshot=>{
    const u = snapshot.val();
    if(u){
      borrowerNameInput.value = u.name || "";
      departmentInput.value = u.department || u.section || "";
      phoneInput.value = u.phone || "";
    }
  });

  loadInventory();
  loadLoans(user.uid);
// ---------------------------------------------------------------
// AUTO-FILL FROM URL PARAMETERS (coming from inventory.html button)
// ---------------------------------------------------------------
const params = new URLSearchParams(window.location.search);
const urlItemId = params.get("itemId");
const urlModel = params.get("model");
const urlBrand = params.get("brand");

if (urlItemId) {
  itemIdInput.value = urlItemId;
  validateItemId(); // triggers inventory lookup
}

if (urlModel) modelInput.value = urlModel;
if (urlBrand) brandInput.value = urlBrand;

// âœ… FINAL FIX: ensure validation runs AGAIN after autofill AND after inventory loads
setTimeout(() => {
  if (itemIdInput.value.trim() !== "") validateItemId();
}, 300);

});



/* ------------------------------------------------------------------
   Load Inventory
------------------------------------------------------------------ */
function loadInventory(){
  onValue(inventoryRef, snapshot=>{
    inventoryMap.clear();
    const data = snapshot.val();
    if(data) Object.values(data).forEach(item=>{
      if(item.serialNumber) inventoryMap.set(cleanId(String(item.serialNumber)), item);
    });

    inventoryLoaded = true;

    // âœ… FIX: Re-run validation AFTER inventory loads 
    if (itemIdInput.value.trim() !== "") {
      validateItemId();
    }
  });
}

/* ------------------------------------------------------------------
   Validate Item ID
------------------------------------------------------------------ */
async function validateItemId(){
  if(!inventoryLoaded){ submitButton.disabled = true; return; }

  const itemId = cleanId(itemIdInput.value);
  submitButton.disabled = true;
  loanResponseMsg.textContent = "";
  loanResponseMsg.className = "";

  if(!itemId) return;

  if(!inventoryMap.has(itemId)){
    loanResponseMsg.textContent = "âŒ Item ID not found in inventory.";
    loanResponseMsg.className = "error";
    return;
  }

  const item = inventoryMap.get(itemId);
  modelInput.value = item.modelNumber || "";
  brandInput.value = item.brand || "";

  const snapshot = await get(query(loansRef, orderByChild("itemId"), equalTo(itemId)));
  let unavailable=false, userHasLoan=false;

  snapshot.forEach(child=>{
    const loan = child.val();
    if(["active","pendingApproval"].includes(loan.status)) unavailable=true;
    if(loan.borrowerUid===auth.currentUser?.uid && loan.status==="active") userHasLoan=true;
  });

  if(userHasLoan){
    loanResponseMsg.textContent = "âš ï¸ You already have this item on active loan.";
    loanResponseMsg.className = "error";
    return;
  }

  if(unavailable){
    loanResponseMsg.textContent = "âŒ Item is already loaned or pending.";
    loanResponseMsg.className = "error";
    return;
  }

  submitButton.disabled = false;
}
itemIdInput.addEventListener("input", validateItemId);

/* ------------------------------------------------------------------
   Submit Loan
------------------------------------------------------------------ */
loanForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const user = auth.currentUser;
  const loanDate = document.getElementById("loanDate").value;
  const returnDate = document.getElementById("returnDate").value;

  if(new Date(returnDate)<new Date(loanDate)){
    loanResponseMsg.textContent="âŒ Return date cannot be earlier than loan date.";
    loanResponseMsg.className="error";
    return;
  }

  try{
    await push(loansRef,{
      borrowerUid: user.uid,
      borrowerName: borrowerNameInput.value,
      department: departmentInput.value,
      phone: phoneInput.value,
      itemId: cleanId(itemIdInput.value),
      model: modelInput.value,
      brand: brandInput.value,
      loanDate,
      returnDate,
      status:"pendingApproval",
      timestamp: serverTimestamp()
    });

    loanResponseMsg.textContent="âœ… Loan request submitted for approval.";
    loanResponseMsg.className="success";
    loanForm.reset();
    submitButton.disabled=true;
    validateItemId();
    loadLoans(user.uid); // refresh list
  }catch(err){
    console.error(err);
    loanResponseMsg.textContent="âŒ Error submitting loan.";
    loanResponseMsg.className="error";
  }
});

/* ------------------------------------------------------------------
   Load Loans & Months Dropdown
------------------------------------------------------------------ */
const userMonthSelect = document.getElementById("userMonthSelect");
const loanUl = document.getElementById("loanUl");

function loadLoans(uid){
  onValue(ref(db,"loans"), snapshot=>{
    allLoans = {};
    const data = snapshot.val();
    const monthSet = new Set();

    if(data) Object.entries(data).forEach(([key, loan])=>{
      if(loan.borrowerUid===uid){
        allLoans[key]=loan;
        monthSet.add(getMonthLabel(loan.loanDate));
      }
    });

    // populate month dropdown
    userMonthSelect.innerHTML='<option value="">--Select Month--</option>';
    Array.from(monthSet).sort().forEach(month=>{
      const opt = document.createElement("option");
      opt.value=month;
      opt.textContent=month;
      userMonthSelect.appendChild(opt);
    });

    loanUl.style.display="none"; // hide until month selected
  });
}

userMonthSelect.addEventListener("change", ()=>{
  const selectedMonth = userMonthSelect.value;
  loanUl.innerHTML="";
  if(!selectedMonth){
    loanUl.style.display="none";
    return;
  }
  loanUl.style.display="block";

  Object.values(allLoans).forEach(loan=>{
    if(getMonthLabel(loan.loanDate)!==selectedMonth) return;

    const li = document.createElement("li");
li.classList.add(`loan-status-${loan.status}`);
li.innerHTML = `
      <strong>Name:</strong> ${loan.borrowerName}<br>
      <strong>Department:</strong> ${loan.department}<br>
      <strong>Phone:</strong> ${loan.phone}<br>
      <strong>Item ID:</strong> ${loan.itemId}<br>
      <strong>Model:</strong> ${loan.model}<br>
      <strong>Brand:</strong> ${loan.brand}<br>
      <strong>Loan Date:</strong> ${loan.loanDate}<br>
      <strong>Return Date:</strong> ${loan.returnDate}<br>
      <strong>Status:</strong> ${loan.status}
    `;
    loanUl.appendChild(li);
  });
});

document.getElementById("logoutBtn").addEventListener("click", ()=>signOut(auth).then(()=>location.href="login.html"));
</script>
</body>
</html>




