<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan Form</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }

    nav { margin-bottom: 20px; }
    nav a { color: black; text-decoration: none; margin-right: 10px; }
    nav a:hover { text-decoration: underline; }
    nav button {
      padding: 6px 12px; cursor: pointer;
      background: none; border: 1px solid #ccc;
      color: black; float: right;
    }

    form {
      max-width: 600px; margin: auto; background: #fff;
      padding: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px 20px;
      align-items: center;
    }

    label { text-align: right; font-weight: bold; }

    input, select {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
    }

    button[type="submit"] {
      grid-column: 2 / 3; padding: 10px 20px;
      background-color: #28a745; color: white; border: none; cursor: pointer;
      border-radius: 4px;
    }
    button[type="submit"]:disabled {
      background-color: #ccc; cursor: not-allowed;
    }

    .success { color: green; grid-column: 2 / 3; }
    .error { color: red; grid-column: 2 / 3; }

    #loanList, #loanAdminSection { max-width: 600px; margin: 30px auto; }

    #loanList ul, #loanAdminSection ul { list-style: none; padding: 0; }
    #loanList li, #loanAdminSection li {
      background: #e9ecef; margin-bottom: 10px;
      padding: 10px; border-radius: 5px; border-left: 5px solid #999;
    }

    #approvalsLink { display: none; }
  </style>
</head>
<body>

<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html" id="approvalsLink">Approvals</a>
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Loan an Item</h2>
<p><a href="inventory.html">ðŸ”™ Back to Inventory</a></p>

<form id="loanForm">
  <label for="borrowerName">Name:</label>
  <input type="text" id="borrowerName" readonly />

  <label for="department">Department:</label>
  <input type="text" id="department" readonly />

  <label for="phone">Phone:</label>
  <input type="text" id="phone" readonly />

  <label for="itemId">Item ID (Serial Number):</label>
  <input type="text" id="itemId" required />

  <label for="model">Model:</label>
  <input type="text" id="model" readonly />

  <label for="brand">Brand:</label>
  <input type="text" id="brand" readonly />

  <label for="loanDate">Loan Date:</label>
  <input type="date" id="loanDate" required />

  <label for="returnDate">Return Date:</label>
  <input type="date" id="returnDate" required />

  <button type="submit" disabled>Submit Loan</button>
</form>

<p id="loanResponseMsg"></p>

<div id="loanList">
  <h3>Your Loan Records</h3>
  <label for="userMonthSelect">Select Month:</label>
  <select id="userMonthSelect">
    <option value="">--Select Month--</option>
  </select>
  <ul id="loanUl"></ul>
</div>

<div id="loanAdminSection" style="display:none;">
  <h3>Manage Loan Requests (Admin)</h3>
  <label for="adminMonthSelect">Select Month:</label>
  <select id="adminMonthSelect">
    <option value="">--Select Month--</option>
  </select>
  <ul id="adminLoanUl"></ul>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, push, get, onChildAdded, onValue, query, orderByChild, equalTo, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
    authDomain: "my-webpage-93c94.firebaseapp.com",
    databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-webpage-93c94",
    storageBucket: "my-webpage-93c94.appspot.com",
    messagingSenderId: "959385466155",
    appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const loanForm = document.getElementById("loanForm");
  const submitButton = loanForm.querySelector("button");
  const loanResponseMsg = document.getElementById("loanResponseMsg");

  const itemIdInput = document.getElementById("itemId");
  const modelInput = document.getElementById("model");
  const brandInput = document.getElementById("brand");

  const borrowerNameInput = document.getElementById("borrowerName");
  const departmentInput = document.getElementById("department");
  const phoneInput = document.getElementById("phone");

  const loansRef = ref(db, "loans");
  const inventoryRef = ref(db, "inventory");

  let inventoryLoaded = false;
  const inventoryMap = new Map();

  /* ðŸ”§ FIX #1 â€” Simplified cleanId() so it doesn't break serials */
  function cleanId(str) { return str ? str.trim() : ""; }

  function getMonthLabel(dateStr) {
    const date = new Date(dateStr);
    const options = { year: "numeric", month: "long" };
    return date.toLocaleDateString(undefined, options);
  }

  /* ---------------------------------------------------------------
     INVENTORY LOAD
  ----------------------------------------------------------------*/
  onValue(inventoryRef, snapshot => {
    inventoryMap.clear();
    const data = snapshot.val();
    if (data) Object.values(data).forEach(item => {
      if (item.serialNumber) inventoryMap.set(cleanId(String(item.serialNumber)), item);
    });

    inventoryLoaded = true;

    const params = new URLSearchParams(window.location.search);

    /* ðŸ”§ FIX #2 â€” decode + clean URL serial */
    const urlSerial = cleanId(decodeURIComponent(params.get("itemId") || ""));

    if (urlSerial) {
      itemIdInput.value = cleanId(urlSerial);

      const urlModel = params.get("model");
      const urlBrand = params.get("brand");
      if (urlModel) modelInput.value = urlModel;
      if (urlBrand) brandInput.value = urlBrand;

      /* ðŸ”§ FIX #3 â€” Validate AFTER DOM + Firebase load completes */
      setTimeout(() => validateItemId(), 0);
    }

    validateItemId();
  });

  /* ---------------------------------------------------------------
     AUTH
  ----------------------------------------------------------------*/
  onAuthStateChanged(auth, async user => {
    if (!user) return (window.location.href = "login.html");

    const token = await user.getIdTokenResult();
    const isAdmin = token.claims.admin;

    if (isAdmin) {
      document.getElementById("approvalsLink").style.display = "inline";
      document.getElementById("loanAdminSection").style.display = "block";
      initializeAdmin();
    }

    const snap = await get(ref(db, "users/" + user.uid));
    if (snap.exists()) {
      const u = snap.val();
      borrowerNameInput.value = u.name;
      departmentInput.value = u.department;
      phoneInput.value = u.phone;
    }

    const loansByMonth = {};
    const userMonthSelect = document.getElementById("userMonthSelect");
    const loanUl = document.getElementById("loanUl");

    onChildAdded(loansRef, data => {
      const loan = data.val();
      if (loan.borrowerUid !== user.uid) return;

      const monthLabel = getMonthLabel(loan.loanDate);
      if (!loansByMonth[monthLabel]) loansByMonth[monthLabel] = [];
      loansByMonth[monthLabel].push(loan);

      updateUserMonthDropdown();
      renderUserLoans(userMonthSelect.value);
    });

    function updateUserMonthDropdown() {
      const currentOptions = Array.from(userMonthSelect.options).map(opt => opt.value);
      Object.keys(loansByMonth).forEach(month => {
        if (!currentOptions.includes(month)) {
          const opt = document.createElement("option");
          opt.value = month; opt.textContent = month;
          userMonthSelect.appendChild(opt);
        }
      });
    }

    userMonthSelect.addEventListener("change", () => {
      renderUserLoans(userMonthSelect.value);
    });

    function renderUserLoans(month) {
      loanUl.innerHTML = "";
      if (!month || !loansByMonth[month]) return;

      loansByMonth[month].forEach(loan => {
        const li = document.createElement("li");
        const color = { active: "green", pendingApproval: "orange", rejected: "red", returned: "blue" }[loan.status] || "#999";
        li.style.borderColor = color;
        li.innerHTML = `
          <strong>${loan.borrowerName}</strong> (${loan.department})<br>
          Item: ${loan.itemId}<br>
          ${loan.model} (${loan.brand})<br>
          Loan: ${loan.loanDate} â†’ ${loan.returnDate}<br>
          <b style="color:${color}">${loan.status}</b>
        `;
        loanUl.appendChild(li);
      });
    }
  });

  /* ---------------------------------------------------------------
     ITEM ID VALIDATION
  --------------------------------------------------------------- */
  async function validateItemId() {
    if (!inventoryLoaded) { submitButton.disabled = true; return; }

    const itemId = cleanId(itemIdInput.value);
    submitButton.disabled = true;
    loanResponseMsg.textContent = "";
    loanResponseMsg.className = "";

    if (!itemId) return;

    if (!inventoryMap.has(itemId)) {
      loanResponseMsg.textContent = "âŒ Item ID not found in inventory.";
      loanResponseMsg.className = "error";
      return;
    }

    const item = inventoryMap.get(itemId);
    modelInput.value = item.modelNumber || modelInput.value;
    brandInput.value = item.brand || brandInput.value;

    const snapshot = await get(query(loansRef, orderByChild("itemId"), equalTo(itemId)));
    let unavailable = false, userHasLoan = false;

    snapshot.forEach(child => {
      const loan = child.val();
      if (["active","pendingApproval"].includes(loan.status)) unavailable = true;
      if (loan.borrowerUid === auth.currentUser?.uid && loan.status === "active") userHasLoan = true;
    });

    if (userHasLoan) {
      loanResponseMsg.textContent = "âš ï¸ You already have this item on active loan.";
      loanResponseMsg.className = "error";
      return;
    }

    if (unavailable) {
      loanResponseMsg.textContent = "âŒ Item is already loaned or pending.";
      loanResponseMsg.className = "error";
      return;
    }

    submitButton.disabled = false;
  }

  itemIdInput.addEventListener("input", validateItemId);

  /* ---------------------------------------------------------------
     SUBMIT LOAN
  --------------------------------------------------------------- */
  loanForm.addEventListener("submit", async e => {
    e.preventDefault();
    const user = auth.currentUser;
    const loanDate = document.getElementById("loanDate").value;
    const returnDate = document.getElementById("returnDate").value;

    if (new Date(returnDate) < new Date(loanDate)) {
      loanResponseMsg.textContent = "âŒ Return date cannot be earlier than loan date.";
      loanResponseMsg.className = "error";
      return;
    }

    try {
      await push(loansRef, {
        borrowerUid: user.uid,
        borrowerName: borrowerNameInput.value,
        department: departmentInput.value,
        phone: phoneInput.value,
        itemId: cleanId(itemIdInput.value),
        model: modelInput.value,
        brand: brandInput.value,
        loanDate,
        returnDate,
        status: "pendingApproval",
        timestamp: serverTimestamp()
      });

      loanResponseMsg.textContent = "âœ… Loan submitted for approval.";
      loanResponseMsg.className = "success";
      loanForm.reset();
      submitButton.disabled = true;
    } catch(err) {
      loanResponseMsg.textContent = "âŒ Error submitting loan.";
      loanResponseMsg.className = "error";
      console.error(err);
    }
  });

  /* ---------------------------------------------------------------
     ADMIN LOGIC
  --------------------------------------------------------------- */
  function initializeAdmin() {
    const adminList = document.getElementById("adminLoanUl");
    const loansByMonthAdmin = {};
    const adminMonthSelect = document.getElementById("adminMonthSelect");

    onValue(loansRef, snapshot => {
      adminList.innerHTML = "";
      const data = snapshot.val() || {};

      Object.entries(data).forEach(([key, loan]) => {
        const monthLabel = getMonthLabel(loan.loanDate);
        if (!loansByMonthAdmin[monthLabel]) loansByMonthAdmin[monthLabel] = [];
        loansByMonthAdmin[monthLabel].push({ key, loan });
      });

      updateAdminMonthDropdown();
      renderAdminLoans(adminMonthSelect.value);
    });

    function updateAdminMonthDropdown() {
      const currentOptions = Array.from(adminMonthSelect.options).map(opt => opt.value);
      Object.keys(loansByMonthAdmin).forEach(month => {
        if (!currentOptions.includes(month)) {
          const opt = document.createElement("option");
          opt.value = month; opt.textContent = month;
          adminMonthSelect.appendChild(opt);
        }
      });
    }

    adminMonthSelect.addEventListener("change", () => {
      renderAdminLoans(adminMonthSelect.value);
    });

    function renderAdminLoans(month) {
      adminList.innerHTML = "";
      if (!month || !loansByMonthAdmin[month]) return;

      loansByMonthAdmin[month].forEach(({ key, loan }) => {
        const li = document.createElement("li");

        let controls = "";
        if (loan.status === "pendingApproval") {
          controls = `<button data-k="${key}" data-act="approve">Approve</button>
                      <button data-k="${key}" data-act="reject">Reject</button>`;
        } else if (loan.status === "active") {
          controls = `<button data-k="${key}" data-act="return">Mark Returned</button>`;
        }

        li.innerHTML = `
          <strong>${loan.borrowerName}</strong><br>
          ${loan.itemId} - ${loan.model} (${loan.brand})<br>
          ${loan.loanDate} â†’ ${loan.returnDate}<br>
          Status: <b>${loan.status}</b><br>${controls}
        `;
        adminList.appendChild(li);
      });
    }

    adminList.addEventListener("click", async e => {
      if (e.target.tagName !== "BUTTON") return;
      const key = e.target.dataset.k;
      const action = e.target.dataset.act;

      const updates = {
        approve: { status: "active" },
        reject: { status: "rejected" },
        return: { status: "returned" }
      };

      await update(ref(db, `loans/${key}`), updates[action]);
    });
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => (window.location.href="login.html"));
  });
</script>
</body>
</html>




