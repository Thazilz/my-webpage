<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan Form</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    
    /* Navigation styles */
    nav {
      font-family: Arial, sans-serif;
      margin-bottom: 20px;
    }
    nav a {
      color: black;
      text-decoration: none;
      margin-right: 10px;
    }
    nav a:hover {
      text-decoration: underline;
    }
    nav button {
      font-family: Arial, sans-serif;
      padding: 6px 12px;
      cursor: pointer;
      background: none;
      border: 1px solid #ccc;
      color: black;
      float: right;
    }
    nav button:hover {
      background: #f0f0f0;
    }

    form {
      max-width: 500px;
      margin: auto;
      background: #f4f4f4;
      padding: 20px;
      border-radius: 8px;
    }
    input, select {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
    }
    button[type="submit"] {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    button[type="submit"]:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    button[type="submit"]:hover:enabled {
      background-color: #218838;
    }

    .success { color: green; text-align: center; }
    .error { color: red; text-align: center; }

    #loanList, #loanAdminSection {
      max-width: 600px;
      margin: 30px auto;
    }
    #loanList ul, #loanAdminSection ul {
      list-style: none;
      padding: 0;
    }
    #loanList li, #loanAdminSection li {
      background: #e9ecef;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      border-left: 5px solid #999;
    }
    #loanAdminSection button {
      margin: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- Navigation -->
<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html">Approvals</a> |
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Loan an Item</h2>
<p><a href="inventory.html">üîô Back to Inventory</a></p>

<form id="loanForm">
  <input type="text" id="borrowerName" placeholder="Borrower's Name" required />
  <input type="text" id="department" placeholder="Department" required />
  <input type="text" id="itemId" placeholder="Item ID" required />
  <input type="text" id="model" placeholder="Model" required />
  <input type="text" id="brand" placeholder="Brand" required />
  <input type="date" id="loanDate" required />
  <input type="date" id="returnDate" required />
  <button type="submit" disabled>Submit Loan</button>
</form>

<p id="loanResponseMsg"></p>

<div id="loanList">
  <h3>Loan Records</h3>
  <ul id="loanUl"></ul>
</div>

<div id="loanAdminSection">
  <h3>Manage Loan Requests (Admin)</h3>
  <ul id="adminLoanUl"></ul>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, push, get, onChildAdded, onValue, query, orderByChild, equalTo, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
    authDomain: "my-webpage-93c94.firebaseapp.com",
    databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-webpage-93c94",
    storageBucket: "my-webpage-93c94.appspot.com",
    messagingSenderId: "959385466155",
    appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const loanAdminSection = document.getElementById('loanAdminSection');
  loanAdminSection.style.display = "none"; // hidden by default

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    signOut(auth).then(() => {
      window.location.href = "login.html";
    }).catch(err => console.error(err));
  });

  // Auth and admin check
  onAuthStateChanged(auth, async user => {
    if (!user) return window.location.href = "login.html";

    // Check admin privileges
    const userRef = ref(db, `users/${user.uid}`);
    const userSnap = await get(userRef);
    const userData = userSnap.val();

    if (userData && userData.isAdmin) {
      console.log("‚úÖ Admin detected:", user.email);
      loanAdminSection.style.display = "block"; // show admin tools
      initializeAdminSection(); // load admin tools
    } else {
      console.log("üë§ Regular user:", user.email);
      loanAdminSection.style.display = "none";
    }
  });

  // Loan Form Logic
  const loansRef = ref(db, 'loans');
  const inventoryRef = ref(db, 'inventory');

  const loanForm = document.getElementById('loanForm');
  const loanResponseMsg = document.getElementById('loanResponseMsg');
  const loanUl = document.getElementById('loanUl');
  const itemIdInput = document.getElementById('itemId');
  const modelInput = document.getElementById('model');
  const brandInput = document.getElementById('brand');
  const submitButton = loanForm.querySelector('button');

  const inventoryMap = new Map();
  let inventoryLoaded = false;

  onValue(inventoryRef, (snapshot) => {
    inventoryMap.clear();
    const data = snapshot.val();
    if (data) {
      Object.values(data).forEach(item => {
        const key = (item.serialNumber || item.itemId || "").trim();
        if (key) inventoryMap.set(key, item);
      });
    }
    inventoryLoaded = true;
  });

  async function validateItemId() {
    const itemId = itemIdInput.value.trim();
    loanResponseMsg.textContent = "";
    loanResponseMsg.className = "";

    if (!inventoryLoaded) {
      submitButton.disabled = true;
      return;
    }

    if (!itemId || !inventoryMap.has(itemId)) {
      submitButton.disabled = true;
      loanResponseMsg.textContent = "‚ùå Item ID not found in inventory.";
      loanResponseMsg.className = "error";
      return;
    }

    const item = inventoryMap.get(itemId);
    if (item) {
      modelInput.value = item.modelNumber || "";
      brandInput.value = item.brand || "";
    }

    const activeLoanQuery = query(loansRef, orderByChild("itemId"), equalTo(itemId));
    const snapshot = await get(activeLoanQuery);
    let unavailable = false;
    snapshot.forEach(child => {
      if (["active", "pendingApproval"].includes(child.val().status)) unavailable = true;
    });

    if (unavailable) {
      submitButton.disabled = true;
      loanResponseMsg.textContent = "‚ùå Item is already on loan or pending approval.";
      loanResponseMsg.className = "error";
    } else {
      submitButton.disabled = false;
    }
  }

  itemIdInput.addEventListener('input', validateItemId);

  loanForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const borrowerName = document.getElementById('borrowerName').value.trim();
    const department = document.getElementById('department').value.trim();
    const itemId = itemIdInput.value.trim();
    const model = modelInput.value.trim();
    const brand = brandInput.value.trim();
    const loanDate = document.getElementById('loanDate').value;
    const returnDate = document.getElementById('returnDate').value;

    if (new Date(returnDate) < new Date(loanDate)) {
      loanResponseMsg.textContent = "‚ùå Return date cannot be before loan date.";
      loanResponseMsg.className = "error";
      return;
    }

    try {
      await push(loansRef, {
        borrowerName,
        department,
        itemId,
        model,
        brand,
        loanDate,
        returnDate,
        status: "pendingApproval",
        timestamp: serverTimestamp()
      });

      loanResponseMsg.textContent = "‚úÖ Loan submitted for approval.";
      loanResponseMsg.className = "success";
      loanForm.reset();
      submitButton.disabled = true;
    } catch (err) {
      console.error(err);
      loanResponseMsg.textContent = "‚ùå Error submitting loan.";
      loanResponseMsg.className = "error";
    }
  });

  // Display all loans color-coded by status
  onChildAdded(loansRef, (data) => {
    const loan = data.val();
    const li = document.createElement('li');
    let color = "#999";
    if (loan.status === "active") color = "green";
    if (loan.status === "pendingApproval") color = "orange";
    if (loan.status === "denied") color = "red";
    if (loan.status === "returned") color = "blue";
    li.style.borderColor = color;

    li.innerHTML = `
      <strong>${loan.borrowerName}</strong> (${loan.department})<br>
      <em>Item ID:</em> ${loan.itemId}<br>
      <em>Model:</em> ${loan.model} | <em>Brand:</em> ${loan.brand}<br>
      <em>Loan Date:</em> ${loan.loanDate} | <em>Return Date:</em> ${loan.returnDate}<br>
      <em>Status:</em> <span style="color:${color}; font-weight:bold;">${loan.status}</span>
    `;
    loanUl.prepend(li);
  });

  // --- ADMIN SECTION LOGIC (only runs if user is admin) ---
  function initializeAdminSection() {
    const adminLoanUl = document.getElementById('adminLoanUl');
    onValue(loansRef, (snapshot) => {
      adminLoanUl.innerHTML = "";
      const loans = snapshot.val();
      if (!loans) {
        adminLoanUl.innerHTML = "<li>No loan requests yet.</li>";
        return;
      }

      Object.entries(loans).forEach(([key, loan]) => {
        const li = document.createElement('li');
        let controls = "";
        if (loan.status === "pendingApproval") {
          controls = `
            <button data-key="${key}" data-action="approve">‚úÖ Approve</button>
            <button data-key="${key}" data-action="deny">‚ùå Deny</button>
          `;
        } else if (loan.status === "active") {
          controls = `<button data-key="${key}" data-action="return">‚Ü©Ô∏è Mark as Returned</button>`;
        }

        li.innerHTML = `
          <strong>${loan.borrowerName}</strong> (${loan.department})<br>
          <em>Item:</em> ${loan.itemId} | ${loan.model} (${loan.brand})<br>
          <em>Loan Date:</em> ${loan.loanDate} ‚Üí <em>Return Date:</em> ${loan.returnDate}<br>
          <em>Status:</em> <b>${loan.status}</b><br>
          ${controls}
        `;
        adminLoanUl.appendChild(li);
      });
    });

    adminLoanUl.addEventListener("click", async (e) => {
      if (e.target.tagName !== "BUTTON") return;
      const key = e.target.dataset.key;
      const action = e.target.dataset.action;

      try {
        if (action === "approve") {
          await update(ref(db, "loans/" + key), { status: "active" });
          alert("Loan approved!");
        } else if (action === "deny") {
          await update(ref(db, "loans/" + key), { status: "denied" });
          alert("Loan denied.");
        } else if (action === "return") {
          await update(ref(db, "loans/" + key), { status: "returned" });
          alert("Loan marked as returned.");
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Error updating loan status.");
      }
    });
  }

  // Prefill from URL
  window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const itemId = params.get('itemId');
    const model = params.get('model');
    const brand = params.get('brand');

    if (itemId) {
      const waitForInventory = () => {
        if (inventoryLoaded) {
          itemIdInput.value = itemId;
          const item = inventoryMap.get(itemId);
          if (!item) {
            if (model) modelInput.value = model;
            if (brand) brandInput.value = brand;
          }
          validateItemId();
        } else {
          setTimeout(waitForInventory, 100);
        }
      };
      waitForInventory();
    }
  });
</script>
</body>
</html>


