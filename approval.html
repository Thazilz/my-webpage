<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Approve Loans & Returns</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }
  nav { margin-bottom: 20px; }
  nav a { color: black; text-decoration: none; margin-right: 10px; }
  nav button { padding: 6px 12px; cursor: pointer; background: none; border: 1px solid #ccc; float: right; }
  nav button:hover { background: #f0f0f0; }
  h2 { margin-top: 30px; }
  .item-container { margin-bottom: 20px; }
  .item { background: #fff; border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; }
  .item button { padding: 6px 10px; margin-right: 5px; cursor: pointer; }
  .approve { background: #28a745; color: white; border: none; }
  .reject { background: #dc3545; color: white; border: none; }
  .approve:hover { background: #218838; }
  .reject:hover { background: #c82333; }
  .status-msg { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html">Approvals</a> |
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Pending Loan Approvals</h2>
<div id="loanContainer" class="item-container"></div>

<h2>Pending Return Approvals</h2>
<div id="returnContainer" class="item-container"></div>

<p id="statusMsg" class="status-msg"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, query, orderByChild, equalTo, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
  authDomain: "my-webpage-93c94.firebaseapp.com",
  databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-webpage-93c94",
  storageBucket: "my-webpage-93c94.appspot.com",
  messagingSenderId: "959385466155",
  appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loanContainer = document.getElementById("loanContainer");
const returnContainer = document.getElementById("returnContainer");
const statusMsg = document.getElementById("statusMsg");

document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(() => location.href = "login.html");
});

// -----------------------------------------------------------
// ADMIN AUTH CHECK
// -----------------------------------------------------------
onAuthStateChanged(auth, async user => {
  if (!user) {
    alert("Access denied. Please log in first.");
    location.href = "login.html";
    return;
  }

  const token = await user.getIdTokenResult();
  if (!token.claims.admin) {
    alert("You are not authorized to access this page.");
    location.href = "index.html";
    return;
  }

  loadPendingItems("loans", loanContainer);
  loadPendingItems("returns", returnContainer);
});

// -----------------------------------------------------------
// LOAD PENDING ITEMS
// -----------------------------------------------------------
function loadPendingItems(path, container) {
  const itemsQuery = query(ref(db, path), orderByChild("status"), equalTo("pendingApproval"));

  onValue(itemsQuery, snapshot => {
    container.innerHTML = "";
    const data = snapshot.val();
    if (!data) {
      container.innerHTML = `<p>No pending ${path.slice(0,-1)}s.</p>`;
      return;
    }

    Object.entries(data).forEach(([id, item]) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <p><strong>${item.borrowerName || "Unknown"}</strong> (${item.department || "-"})</p>
        <p>Item ID: ${item.itemId || "-"}</p>
        <p>Model: ${item.model || "-"} | Brand: ${item.brand || "-"}</p>
        ${path === "loans" ? `<p>Loan Date: ${item.loanDate || "-"} | Return Date: ${item.returnDate || "-"}</p>` 
                            : `<p>Return Date: ${item.returnDate || "-"}</p>`}
        <button class="approve">Approve</button>
        <button class="reject">Reject</button>
      `;
      attachApprovalHandlers(div, path, id, item);
      container.appendChild(div);
    });
  });
}

// -----------------------------------------------------------
// APPROVAL HANDLERS
// -----------------------------------------------------------
function attachApprovalHandlers(div, path, id, item) {
  const approveBtn = div.querySelector(".approve");
  const rejectBtn = div.querySelector(".reject");

  approveBtn.addEventListener("click", async () => {
    if (!confirm(`Approve ${item.itemId}?`)) return;
    await handleApprovalUpdate(div, path, id, item, "approve");
  });

  rejectBtn.addEventListener("click", async () => {
    if (!confirm(`Reject ${item.itemId}?`)) return;
    await handleApprovalUpdate(div, path, id, item, "reject");
  });
}

// -----------------------------------------------------------
// HANDLE APPROVAL UPDATE
// -----------------------------------------------------------
async function handleApprovalUpdate(div, path, id, item, action) {
  const buttons = div.querySelectorAll("button");
  buttons.forEach(btn => btn.disabled = true);

  try {
    const statusMap = {
      loans: { approve: "active", reject: "rejected" },
      returns: { approve: "returned", reject: "rejected" }
    };

    const newStatus = statusMap[path][action];
    if (!newStatus) throw new Error("Invalid action/status mapping.");

    // Update main request
    await update(ref(db, `${path}/${id}`), { status: newStatus });

    // üîß FIX ‚Äî Update associated loan and inventory for returns only AFTER admin approval
    if (path === "returns" && newStatus === "returned") {
      if (!item.loanKey) throw new Error(`Return request missing associated loan key for ${item.itemId}.`);

      // Update loan status
      await update(ref(db, `loans/${item.loanKey}`), { status: "returned" });

      // Update inventory availability
      const inventoryQuery = query(ref(db, "inventory"), orderByChild("serialNumber"), equalTo(item.itemId));
      const inventorySnapshot = await get(inventoryQuery);

      const inventoryUpdates = {};
      inventorySnapshot.forEach(invSnap => {
        inventoryUpdates[invSnap.key + '/available'] = true;
      });

      if (Object.keys(inventoryUpdates).length > 0) {
        await update(ref(db, "inventory"), inventoryUpdates);
      }
    }

    div.remove();
    showStatus(`‚úÖ ${item.itemId} ${newStatus}.`, newStatus === "rejected" ? "red" : "green");

  } catch (err) {
    console.error(err);
    buttons.forEach(btn => btn.disabled = false);
    showStatus(`‚ùå Error updating ${item.itemId}: ${err.message}`, "red");
  }
}

function showStatus(msg, color) {
  statusMsg.textContent = msg;
  statusMsg.style.color = color;
}
</script>
</body>
</html>



