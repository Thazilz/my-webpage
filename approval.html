<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Approve Loans & Returns</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }
    nav { margin-bottom: 20px; }
    nav a { color: black; text-decoration: none; margin-right: 10px; }
    nav a:hover { text-decoration: underline; }
    nav button { padding: 6px 12px; cursor: pointer; background: none; border: 1px solid #ccc; float: right; }
    nav button:hover { background: #f0f0f0; }

    h2 { margin-top: 30px; }
    .item-container { margin-bottom: 20px; }
    .item { background: #fff; border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; }
    .item button { padding: 6px 10px; margin-right: 5px; cursor: pointer; }
    .approve { background: #28a745; color: white; border: none; }
    .reject { background: #dc3545; color: white; border: none; }
    .approve:hover { background: #218838; }
    .reject:hover { background: #c82333; }
    .status-msg { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<nav>
  <a href="index.html">Home</a> |
  <a href="inventory.html">Inventory</a> |
  <a href="loan.html">Loan</a> |
  <a href="return.html">Return</a> |
  <a href="approval.html">Approvals</a> |
  <button id="logoutBtn">Logout</button>
</nav>
<hr>

<h2>Pending Loan Approvals</h2>
<div id="loanContainer" class="item-container"></div>

<h2>Pending Return Approvals</h2>
<div id="returnContainer" class="item-container"></div>

<p id="statusMsg" class="status-msg"></p>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getDatabase, ref, query, orderByChild, equalTo, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  // === Firebase Config ===
  const firebaseConfig = {
    apiKey: "AIzaSyA67aMWlPYaAeh_07o1EaP8mkA2-rhYsUs",
    authDomain: "my-webpage-93c94.firebaseapp.com",
    databaseURL: "https://my-webpage-93c94-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-webpage-93c94",
    storageBucket: "my-webpage-93c94.appspot.com",
    messagingSenderId: "959385466155",
    appId: "1:959385466155:web:e817821e92fa0acc6ec16e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const loanContainer = document.getElementById("loanContainer");
  const returnContainer = document.getElementById("returnContainer");
  const statusMsg = document.getElementById("statusMsg");

  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => location.href = "login.html");
  });

  // Check auth and admin claim
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("Access denied. Please log in first.");
      location.href = "login.html";
      return;
    }

    const token = await user.getIdTokenResult();
    if (!token.claims.admin) {
      alert("You are not authorized to access this page.");
      location.href = "index.html";
      return;
    }

    // Load pending loans and returns
    loadPendingItems("loans", loanContainer, "pendingApproval", "active", "rejected");
    loadPendingItems("returns", returnContainer, "pendingApproval", "approved", "rejected");
  });

  // DRY function to load pending items
  function loadPendingItems(path, container, pendingStatus, approveStatus, rejectStatus) {
    const itemsQuery = query(ref(db, path), orderByChild("status"), equalTo(pendingStatus));

    onValue(itemsQuery, snapshot => {
      container.innerHTML = "";
      const data = snapshot.val();
      if (!data) {
        container.innerHTML = `<p>No pending ${path.slice(0, -1)}s.</p>`;
        return;
      }

      Object.entries(data).forEach(([id, item]) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <p><strong>${item.borrowerName || "Unknown"}</strong> (${item.department || "-"})</p>
          <p>Item ID: ${item.itemId || "-"}</p>
          <p>Model: ${item.model || "-"} | Brand: ${item.brand || "-"}</p>
          ${path === "loans" ? `<p>Loan Date: ${item.loanDate || "-"} | Return Date: ${item.returnDate || "-"}</p>` : `<p>Return Date: ${item.returnDate || "-"}</p>`}
          <button class="approve">Approve</button>
          <button class="reject">Reject</button>
        `;
        attachApprovalHandlers(div, path, id, item.itemId, approveStatus, rejectStatus);
        container.appendChild(div);
      });
    });
  }

  // DRY function to handle approval/rejection buttons
  function attachApprovalHandlers(div, path, id, itemId, approveStatus, rejectStatus) {
    const approveBtn = div.querySelector(".approve");
    const rejectBtn = div.querySelector(".reject");

    approveBtn.addEventListener("click", async () => {
      if (!confirm(`Approve ${itemId}?`)) return;
      await handleApprovalUpdate(div, path, id, approveStatus, itemId, "approved", "green");
    });

    rejectBtn.addEventListener("click", async () => {
      if (!confirm(`Reject ${itemId}?`)) return;
      await handleApprovalUpdate(div, path, id, rejectStatus, itemId, "rejected", "red");
    });
  }

  // Handle Firebase update, inventory update, and status messages
  async function handleApprovalUpdate(div, path, id, status, itemId, actionText, color) {
    const buttons = div.querySelectorAll("button");
    buttons.forEach(btn => btn.disabled = true);

    try {
      // Update loan/return status
      await update(ref(db, `${path}/${id}`), { status });

      // Special handling for approved returns
      if (path === "returns" && status === "approved") {
        // Mark original loan as returned
        const loanQuery = query(ref(db, "loans"), orderByChild("itemId"), equalTo(itemId));
        const loanSnapshot = await get(loanQuery);
        loanSnapshot.forEach(async (loanSnap) => {
          await update(ref(db, `loans/${loanSnap.key}`), { status: "returned" });
        });

        // Update inventory to available
        const inventoryQuery = query(ref(db, "inventory"), orderByChild("itemId"), equalTo(itemId));
        const inventorySnapshot = await get(inventoryQuery);
        inventorySnapshot.forEach(async (invSnap) => {
          await update(ref(db, `inventory/${invSnap.key}`), { available: true });
        });
      }

      div.remove();
      showStatus(`✅ ${itemId} ${actionText}.`, color);
    } catch (err) {
      console.error(err);
      buttons.forEach(btn => btn.disabled = false);
      showStatus(`❌ Error updating ${itemId}.`, "red");
    }
  }

  function showStatus(msg, color) {
    statusMsg.textContent = msg;
    statusMsg.style.color = color;
  }
</script>
</body>
</html>



